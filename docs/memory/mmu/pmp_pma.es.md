# Protección de la dirección física

La protección de la dirección física se divide en dos partes: PMP (Protección de memoria física) y PMA (Atributo de memoria física).
La arquitectura de Yanqihu admite comprobaciones PMA codificadas, pero no comprobaciones PMP. La estructura Nanhu agrega soporte para PMP y también admite implementaciones de PMA legibles y escribibles por software.

La implementación de PMP sigue el manual de RV, con un valor predeterminado de 16 elementos, que se pueden ajustar mediante parámetros (pero deben ser múltiplos de 8). Por razones de tiempo, se adopta un método de implementación distribuido y replicado. El registro PMP en la unidad CSR es responsable de instrucciones como CSRRW. Hay una copia del registro PMP en la búsqueda de instrucciones del front-end, el acceso a la memoria del back-end, y Page Walker. La señal de escritura CSR garantiza la coherencia con el registro PMP en la unidad CSR.

La implementación de PMA adopta un enfoque similar a PMP, utilizando dos bits reservados del registro de configuración de PMP, configurados como atómicos y almacenables en caché, lo que indica si se admiten operaciones atómicas y si se pueden almacenar en caché. Según el manual, el registro PMP no tiene valor inicial (vacío por defecto). El registro PMA tiene un valor inicial por defecto y debe configurarse manualmente para que sea coherente con el atributo de dirección de la plataforma. El registro PMA utiliza el espacio de dirección de registro reservado CSR de estado M, 16 elementos, y se puede parametrizar.

PMP y PMA verifican consultas paralelas y, si se viola alguno de los permisos, es una operación ilegal. Todos los accesos a direcciones físicas dentro del núcleo están sujetos a verificaciones de permisos de direcciones físicas, incluso después de las verificaciones ITLB y DTLB y antes de los accesos a la memoria de Page Walker. Según el manual, Page Fault tiene una prioridad mayor que Access Fault. Sin embargo, cuando Page Walker encuentra Access Fault, la entrada de la tabla de páginas no es válida. En este caso, se produce una situación especial en la que Page Fault y Access Fault ocurren al mismo tiempo. . Xiangshan elige informar sobre errores de acceso o no de acuerdo con el manual.

Según el manual, las comprobaciones PMP y PMA deben ser comprobaciones dinámicas, es decir, deben ser traducidas por TLB y la dirección física traducida debe usarse para la comprobación de permisos de dirección física. Sin embargo, debido a consideraciones de tiempo, los resultados de la inspección de la parte de la página normal de DTLB se consultan con antelación y se almacenan en la entrada de TLB. Para este fin, la granularidad de PMP y PMA debe aumentarse a 4 KB.

Cuando los periféricos como DMA acceden a la memoria, también se requieren verificaciones de direcciones físicas. Por lo tanto, se implementa una versión de PMA mapeada en memoria para que la utilicen los periféricos como DMA.
